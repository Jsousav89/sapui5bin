<!DOCTYPE HTML>
<html>
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta charset="UTF-8">

    <title>HAR Viewer</title>

    <script id="sap-ui-bootstrap"
      type="text/javascript"
      src="/sapui5/latest/resources/sap-ui-core.js"
      data-sap-ui-theme="sap_bluecrystal"
      data-sap-ui-libs="sap.m"
      data-sap-ui-xx-bindingSyntax="complex"
    >
    </script>

    <script id="Root" type="sapui5/xmlview">
      <mvc:View
        controllerName="local.root.controller"
        xmlns:mvc="sap.ui.core.mvc"
        xmlns="sap.m">
        <SplitApp id="idRoot" />
      </mvc:View>
    </script>

    <script id="Master" type="sapui5/xmlview">
      <mvc:View
        controllerName="local.masterdetail.controller"
        xmlns:mvc="sap.ui.core.mvc"
        xmlns="sap.m">
        <Page
          title="Requests">
          <List id="idList"
            mode="SingleSelectMaster"
            select="onSelect"
            noDataText="Loading log entries"
            items="{/log/entries}">
            <items>
              <ObjectListItem
                icon="sap-icon://{
                  path : 'request/url',
                  formatter : 'local.Formatter.iconFromURL'
                }"
                intro="{
                  path : 'request/url',
                  formatter : 'local.Formatter.pathFromURL'
                }"
                title="{
                  path : 'request/url',
                  formatter : 'local.Formatter.nameFromURL'
                }">
                <firstStatus>
                  <ObjectStatus
                    text="{
                      path : 'request/url',
                      formatter : 'local.Formatter.typeFromURL'
                    }" />
                </firstStatus>
                <attributes>
                  <ObjectAttribute
                    text="{response/content/mimeType}" />
                </attributes>
              </ObjectListItem>
            </items>
          </List>
          <footer>
            <Bar>
            </Bar>
          </footer>
        </Page>
      </mvc:View>
    </script>

    <script id="Detail" type="sapui5/xmlview">
      <mvc:View
        controllerName="local.masterdetail.controller"
        xmlns:mvc="sap.ui.core.mvc"
        xmlns="sap.m">
        <Page
          title="Request">
          <ObjectHeader
            icon="sap-icon://{
              path : 'request/url',
              formatter : 'local.Formatter.iconFromURL'
            }"
            intro="{
              path : 'request/url',
              formatter : 'local.Formatter.pathFromURL'
            }"
            title="{
              path : 'request/url',
              formatter : 'local.Formatter.nameFromURL'
            }">
            <firstStatus>
              <ObjectStatus
                text="{
                  path : 'request/url',
                  formatter : 'local.Formatter.typeFromURL'
                }" />
            </firstStatus>
            <attributes>
              <ObjectAttribute
                text="{response/content/mimeType}" />
            </attributes>
          </ObjectHeader>
          <IconTabBar>
            <items>
              <IconTabFilter
                text="Content">
                <TextArea
                  rows="30"
                  cols="100"
                  value="{response/content/text}" />
              </IconTabFilter>
            </items>
          </IconTabBar>
          <footer>
            <Bar>
            </Bar>
          </footer>
        </Page>
      </mvc:View>
    </script>


    <script>

      jQuery.sap.declare("local.Formatter");
      local.Formatter = {

        URLRoot : "https://ec2-54-236-207-58.compute-1.amazonaws.com:1081",

        types : {
          odata : { re : /\/sap\/opu\/odata/, icon : "database" },
          application : { re : /\/sap\/bc\/ui5_ui5\/sap/, icon : "header" },
          library : { re : /\/sap\/bc\/ui5_ui5\/ui2\/ushell\/resources/, icon : "detail-view" },
        },

        determinePathAndType : function(sPath) {
          var info = {};
          Object.keys(local.Formatter.types).forEach(function(sType) {
            if (!info.type) {
              var mTypeInfo = local.Formatter.types[sType];
              info.path = sPath.replace(mTypeInfo.re, "");
              if (info.path !== sPath) {
                info.type = sType;
                info.icon = mTypeInfo.icon;
              }
            }
          });
          return info;
        },

        parseURL : function(sURL) {
          var re = new RegExp("^" + local.Formatter.URLRoot + "(.+)\/(.+?)$");
          var results = re.exec(sURL);
          var info = {};
          if (results) {
            info = {
              path : results[1],
              name : results[2]
            };
            jQuery.extend(info, local.Formatter.determinePathAndType(info.path));
          }
          return info;
        },

        // Need to refactor this stuff, hrm. Perhaps too much
        // stuff in this Formatter, might be worth massaging the
        // data in the model once it's loaded, instead
        // nameFromURL : compose(get("name"), local.Formatter.parseURL(sURL)),

        nameFromURL : function(sURL) {
          return local.Formatter.parseURL(sURL).name;
        },

        pathFromURL : function(sURL) {
          return local.Formatter.parseURL(sURL).path;
        },

        typeFromURL : function(sURL) {
          return local.Formatter.parseURL(sURL).type;
        },

        iconFromURL : function(sURL) {
          return local.Formatter.parseURL(sURL).icon;
        }

      };


      // Root controller definition
      sap.ui.controller("local.root.controller", {

        returnView : function(sViewName) {
          return sap.ui.xmlview(sViewName, {
            viewContent : jQuery("#" + sViewName).html()
          });
        },

        onInit : function() {
          this.oSplitApp = this.getView().byId("idRoot");
          this.oSplitApp.addMasterPage(this.returnView("Master"));
          this.oSplitApp.addDetailPage(this.returnView("Detail"));

          // Sharing the gift of navigation!
          this.oSplitApp.getMasterPage("Master").getController().nav = this;
        },

        navTo : function(sPageId, oContext) {
          var oPage = this.oSplitApp.getPage(sPageId);
          this.oSplitApp.to(sPageId);
          if (oContext) {
            oPage.setBindingContext(oContext);
          }
        }

      });

      // Master & Detail controller definition (experimental)
      sap.ui.controller("local.masterdetail.controller", {

        onInit : function() {
          sap.ui.getCore().getEventBus().subscribe("data", "requestComplete", function() {
            var oView = this.getView();
            if (oView.getId() === "Master") {
              var oList = oView.byId("idList");
              var oFirstItem = oList.getItems()[0];
              oList.setSelectedItem(oFirstItem);
              this.selectItem(oFirstItem);
            }
          }, this);
        },

        selectItem : function(oItem) {
          this.nav.navTo("Detail", oItem.getBindingContext());
        },

        onSelect : function(oEvent) {
          var oItem = oEvent.getParameter("listItem") || oEvent.getSource();
          this.selectItem(oItem);
        }

      });

      function enhanceData(oModel) {
        var urlRoot = "https://ec2-54-236-207-58.compute-1.amazonaws.com:1081",
            re = new RegExp("^" + urlRoot + "(\/sap\/opu\/odata|\/sap\/bc\/ui5_ui5\/sap|\/sap\/bc\/ui5_ui5\/ui2\/ushell\/resources)(\/.+)\/(.+?)$"),
            data = oModel.getData();

        data.log.entries = data.log.entries.map(function(d) {
          var match = d.request.url.match(re),
              infoMap = {
                '/sap/opu/odata' : { type : "Database", icon : "database" },
                '/sap/bc/ui5_ui5/sap' : { type : "Application", icon : "header" },
                '/sap/bc/ui5_ui5/ui2/ushell/resources' : { type : "Library", icon : "detail-view" }
              };

          var obj = {
            name : match[3] || "Unknown",
            path : match[2] || "Unknown"
          };

          jQuery.extend(obj, infoMap[match[1]]);
          jQuery.extend(d.request, { urlData : obj });
          
          return d;
        });

        oModel.setData(data);
      }

      var sURL = "hardata.json";
      var oModel = new sap.ui.model.json.JSONModel(sURL);
      oModel.attachEventOnce('requestCompleted', function() {
        enhanceData(oModel);
        sap.ui.getCore().getEventBus().publish("data", "requestComplete");
      });
      sap.ui.xmlview({ viewContent: jQuery('#Root').html() })
        .setModel(oModel)
        .placeAt('content');

    </script>

  </head>

  <body class="sapUiBody" id="content" />
</html>
